<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>مغسلة شباب المعرة | ERP</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, doc, setDoc, updateDoc, getDoc, collection, addDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDkJMYhBvNCbjBPlidUW4y1YEkJIkUXvck",
      authDomain: "mghsalt-shabab-maarra.firebaseapp.com",
      projectId: "mghsalt-shabab-maarra",
      storageBucket: "mghsalt-shabab-maarra.firebasestorage.app",
      messagingSenderId: "89159652894",
      appId: "1:89159652894:web:c2a88017020777617e000f"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Sign-in logic
    async function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      try {
        await signInWithEmailAndPassword(auth, email, password);
        window.location.href = "#dashboard";  // redirect after login
      } catch (error) {
        alert("فشل تسجيل الدخول: " + error.message);
      }
    }
  </script>

</head>

<body class="bg-gray-100 text-gray-800">

<!-- ================= LOGIN PAGE ================= -->
<div id="login-page" class="flex justify-center items-center h-screen">
  <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
    <h2 class="text-2xl font-bold mb-4 text-center">تسجيل الدخول</h2>
    <input id="email" type="email" placeholder="البريد الإلكتروني" class="input mb-4" />
    <input id="password" type="password" placeholder="كلمة السر" class="input mb-4" />
    <button onclick="login()" class="btn w-full">تسجيل الدخول</button>
  </div>
</div>

<!-- ================= DASHBOARD PAGE ================= -->
<div id="dashboard" class="hidden">
  <!-- Navbar / Sidebar -->
  <div class="flex justify-between p-4 bg-blue-500 text-white">
    <h1 class="text-2xl font-bold">مغسلة شباب المعرة</h1>
    <button onclick="signOut()" class="bg-red-500 px-4 py-2 rounded">تسجيل الخروج</button>
  </div>

  <!-- Tabs -->
  <div class="flex gap-2 mb-4 flex-wrap p-4">
    <button onclick="showTab('laundry')" class="tab">المغسلة</button>
    <button onclick="showTab('espresso')" class="tab">اسبريسو</button>
    <button onclick="showTab('employees')" class="tab">الموظفون</button>
    <button onclick="showTab('daily')">مدخول ومصروف يومي</button>
    <button onclick="showTab('currency')">سعر صرف العملات</button>
  </div>

  <!-- ================= LAYOUT TABS ================= -->

  <section id="laundry" class="tab-content hidden p-4">
    <h2 class="font-bold mb-2">منتجات المغسلة</h2>
    <!-- Product Management for Laundry -->
    <div>
      <input id="product-name" placeholder="اسم المنتج" class="input" />
      <input id="product-price" type="number" placeholder="السعر" class="input" />
      <input id="product-quantity" type="number" placeholder="العدد" class="input" />
      <select id="currency" class="input">
        <option>USD</option><option>TRY</option><option>SYP</option>
      </select>
      <input type="file" id="product-image" class="input" />
      <button onclick="addProduct('laundry')" class="btn">إضافة منتج</button>
    </div>
    <div id="laundry-products-list">
      <!-- Products List will be displayed here -->
    </div>
  </section>

  <section id="espresso" class="tab-content hidden p-4">
    <h2 class="font-bold mb-2">منتجات اسبريسو</h2>
    <!-- Product Management for Espresso -->
    <div>
      <input id="espresso-name" placeholder="اسم المنتج" class="input" />
      <input id="espresso-price" type="number" placeholder="السعر" class="input" />
      <input id="espresso-quantity" type="number" placeholder="العدد" class="input" />
      <select id="espresso-currency" class="input">
        <option>USD</option><option>TRY</option><option>SYP</option>
      </select>
      <input type="file" id="espresso-image" class="input" />
      <button onclick="addProduct('espresso')" class="btn">إضافة منتج</button>
    </div>
    <div id="espresso-products-list">
      <!-- Products List will be displayed here -->
    </div>
  </section>

  <section id="employees" class="tab-content hidden p-4">
    <h2 class="font-bold mb-2">إدارة الموظفين</h2>
    <div id="employee-list">
      <!-- Employees will be listed here -->
    </div>
  </section>

  <section id="daily" class="tab-content hidden p-4">
    <h2 class="font-bold mb-2">المصروفات والإيرادات اليومية</h2>
    <input id="income" placeholder="الإيرادات" class="input mb-4" />
    <input id="expense" placeholder="المصاريف" class="input mb-4" />
    <button onclick="addDailyTransaction()" class="btn">إضافة معاملة</button>
    <div id="daily-transactions">
      <!-- Transactions will be displayed here -->
    </div>
  </section>

  <section id="currency" class="tab-content hidden p-4">
    <h2 class="font-bold mb-2">سعر صرف العملات</h2>
    <!-- Currency exchange rates will be displayed here -->
  </section>
</div>

<!-- ================= STYLES ================= -->
<style>
  .tab { background:#e5e7eb; padding:6px 12px; border-radius:6px; cursor: pointer }
  .tab-content { background:#fff; padding:16px; border-radius:8px; }
  .input { display:block; margin:4px 0; padding:8px; border:1px solid #ccc; border-radius:6px; width:100% }
  .btn { background:#2563eb; color:white; padding:8px 12px; border-radius:6px; margin-top:6px; width:100% }
</style>

<!-- ================= LOGIC ================= -->
<script>
  function showTab(id) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
  }

  // Sign Out Function
  function signOut() {
    auth.signOut().then(() => {
      window.location.href = "#login-page";  // redirect to login page
    });
  }

  async function addProduct(section) {
      const name = document.getElementById(`${section}-name`).value;
      const price = document.getElementById(`${section}-price`).value;
      const quantity = document.getElementById(`${section}-quantity`).value;
      const currency = document.getElementById(`${section}-currency`).value;
      const file = document.getElementById(`${section}-image`).files[0];

      // رفع الصورة إلى Cloudinary
      const imageUrl = file ? await uploadToCloudinary(file) : "";

      // تخزين المنتج في Firestore
      await addDoc(collection(db, section), {
        name: name,
        price: price,
        quantity: quantity,
        image: imageUrl,
        currency: currency,
        createdAt: new Date(),
      });

      // تحديث واجهة المستخدم
      loadProducts(section);
      alert("تم إضافة المنتج بنجاح");
    }

    // دالة رفع الصورة إلى Cloudinary
    async function uploadToCloudinary(file) {
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", CLOUDINARY_PRESET);

      const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
        method: 'POST',
        body: formData
      });
      const data = await response.json();
      return data.secure_url;
    }

    // تحميل المنتجات من Firestore
    async function loadProducts(section) {
      const querySnapshot = await getDocs(collection(db, section));
      const productList = document.getElementById(`${section}-products-list`);
      productList.innerHTML = "";  // مسح قائمة المنتجات السابقة

      querySnapshot.forEach((doc) => {
        const product = doc.data();
        const productItem = document.createElement("div");
        productItem.className = "mb-4 p-4 border rounded-lg shadow-sm";

        productItem.innerHTML = `
          <img src="${product.image}" alt="${product.name}" class="w-32 h-32 object-cover mb-2">
          <p><strong>المنتج:</strong> ${product.name}</p>
          <p><strong>السعر:</strong> ${product.price} ${product.currency}</p>
          <p><strong>العدد المتبقي:</strong> ${product.quantity}</p>
          <button onclick="editProduct('${doc.id}', '${section}')" class="btn w-full mt-2">تعديل</button>
        `;
        productList.appendChild(productItem);
      });
    }

    // تعديل المنتج
    function editProduct(productId, section) {
      // يمكن إضافة منطق لتعديل المنتج هنا
      alert(`تعديل المنتج ${productId} في قسم ${section}`);
    }

    // تحميل المنتجات عند تحميل الصفحة
    window.onload = () => {
      loadProducts('laundry');
      loadProducts('espresso');
    };
</script>
</body>
</html>
