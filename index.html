<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مغسلة شباب المعرة - V4</title>
    
    <!-- Bootstrap 5 & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">
    <!-- Toastify & Flatpickr -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <style>
        :root {
            /* V4 Slate Palette - Comfortable Dark Mode */
            --bg-body: #0f172a;       /* Slate 900 */
            --bg-sidebar: #1e293b;    /* Slate 800 */
            --bg-card: #334155;       /* Slate 700 */
            --border-color: #475569;  /* Slate 600 */
            --text-primary: #f8fafc;  /* Slate 50 */
            --text-secondary: #cbd5e1;/* Slate 300 */
            
            --accent-blue: #38bdf8;   /* Sky 400 */
            --accent-green: #4ade80;  /* Green 400 */
            --accent-orange: #fbbf24; /* Amber 400 */
            --accent-red: #f87171;    /* Red 400 */
        }

        body {
            font-family: 'Almarai', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* Overrides */
        .card { background-color: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 12px; }
        .form-control, .form-select {
            background-color: var(--bg-body); border: 1px solid var(--border-color); color: var(--text-primary);
        }
        .form-control:focus, .form-select:focus {
            background-color: var(--bg-sidebar); border-color: var(--accent-blue); color: white; box-shadow: 0 0 0 0.25rem rgba(56, 189, 248, 0.25);
        }
        .table { color: var(--text-secondary); --bs-table-hover-color: white; --bs-table-hover-bg: #475569; }
        .table thead th { background-color: var(--bg-sidebar); color: var(--accent-blue); border-bottom: 2px solid var(--border-color); }
        .table td { border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .modal-content { background-color: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-primary); }
        .btn-close { filter: invert(1); }

        /* Sidebar */
        .sidebar { background-color: var(--bg-sidebar); min-height: 100vh; border-left: 1px solid var(--border-color); }
        .nav-link { color: var(--text-secondary); padding: 12px; margin-bottom: 5px; border-radius: 8px; transition: 0.3s; }
        .nav-link:hover, .nav-link.active { background-color: rgba(56, 189, 248, 0.1); color: var(--accent-blue); font-weight: bold; transform: translateX(-5px); }
        .nav-link i { width: 25px; text-align: center; }

        /* Custom Components */
        .stat-card { padding: 20px; border-radius: 12px; background: linear-gradient(145deg, var(--bg-card), var(--bg-sidebar)); border-top: 4px solid transparent; }
        .stat-usd { border-color: var(--accent-green); }
        .stat-try { border-color: var(--accent-blue); }
        .stat-syp { border-color: var(--accent-orange); }

        .customer-row { cursor: pointer; transition: 0.2s; }
        .customer-row:hover { background-color: var(--border-color); }

        /* Utils */
        .text-usd { color: var(--accent-green) !important; }
        .text-try { color: var(--accent-blue) !important; }
        .text-syp { color: var(--accent-orange) !important; }
        .bg-dark-overlay { background: rgba(15, 23, 42, 0.9); }

        .app-section { display: none; animation: fadeIn 0.4s; }
        .app-section.active-section { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Invoice Print Style */
        #invoice-print-container { background: white; color: black; padding: 20px; width: 80mm; display: none; }
    </style>
</head>
<body>

    <!-- Loading -->
    <div id="loading-overlay" class="position-fixed top-0 start-0 w-100 h-100 bg-dark-overlay d-flex flex-column justify-content-center align-items-center" style="z-index: 9999;">
        <div class="spinner-border text-info mb-3"></div>
        <h6>جاري التحميل...</h6>
    </div>

    <!-- Login -->
    <div id="login-screen" class="vh-100 d-flex justify-content-center align-items-center d-none">
        <div class="card p-5 shadow-lg" style="width: 400px;">
            <div class="text-center mb-4">
                <i class="fas fa-soap fa-3x text-info mb-3"></i>
                <h3 class="fw-bold">مغسلة شباب المعرة</h3>
            </div>
            <form id="loginForm">
                <input type="email" id="email" class="form-control mb-3" placeholder="Email" required>
                <input type="password" id="password" class="form-control mb-3" placeholder="Password" required>
                <button class="btn btn-info w-100 fw-bold">دخول</button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="d-none">
        <div class="container-fluid p-0">
            <div class="row g-0">
                <!-- Sidebar -->
                <div class="col-md-2 sidebar p-3 d-none d-md-block">
                    <h5 class="text-center text-white mb-4 pb-3 border-bottom border-secondary">لوحة التحكم</h5>
                    <nav class="nav flex-column">
                        <a class="nav-link active" onclick="router.navigate('dashboard')"><i class="fas fa-home"></i> الرئيسية</a>
                        <a class="nav-link" onclick="router.navigate('laundry')"><i class="fas fa-tshirt"></i> المغسلة</a>
                        <a class="nav-link" onclick="router.navigate('espresso')"><i class="fas fa-coffee"></i> الأسبريسو</a>
                        <a class="nav-link" onclick="router.navigate('finance')"><i class="fas fa-chart-pie"></i> المالية</a>
                        <a class="nav-link mt-auto text-danger" onclick="auth.signOut()"><i class="fas fa-sign-out-alt"></i> خروج</a>
                    </nav>
                </div>

                <!-- Content -->
                <div class="col-md-10 vh-100 overflow-auto">
                    <!-- Mobile Header -->
                    <div class="d-md-none bg-secondary p-3 d-flex justify-content-between">
                        <span class="fw-bold">مغسلة شباب المعرة</span>
                        <button class="btn btn-sm btn-dark" data-bs-toggle="collapse" data-bs-target="#mobileMenu"><i class="fas fa-bars"></i></button>
                    </div>
                    <!-- Mobile Menu -->
                    <div class="collapse d-md-none bg-dark p-2" id="mobileMenu">
                        <button class="btn btn-dark w-100 text-end mb-1" onclick="router.navigate('dashboard')">الرئيسية</button>
                        <button class="btn btn-dark w-100 text-end mb-1" onclick="router.navigate('laundry')">المغسلة</button>
                        <button class="btn btn-dark w-100 text-end mb-1" onclick="router.navigate('finance')">المالية</button>
                    </div>

                    <div class="p-4">
                        
                        <!-- 1. Dashboard -->
                        <div id="dashboard-section" class="app-section active-section">
                            <h3 class="mb-4">نظرة عامة</h3>
                            <div class="row g-4">
                                <div class="col-md-4"><div class="stat-card stat-usd"><h6>ديون (USD)</h6><h2 class="text-usd" id="dash-usd">0 $</h2></div></div>
                                <div class="col-md-4"><div class="stat-card stat-try"><h6>ديون (TRY)</h6><h2 class="text-try" id="dash-try">0 ₺</h2></div></div>
                                <div class="col-md-4"><div class="stat-card stat-syp"><h6>ديون (SYP)</h6><h2 class="text-syp" id="dash-syp">0</h2></div></div>
                            </div>
                        </div>

                        <!-- 2. Laundry Section -->
                        <div id="laundry-section" class="app-section">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h3 class="text-info"><i class="fas fa-tshirt"></i> إدارة المغسلة</h3>
                            </div>
                            
                            <ul class="nav nav-tabs border-secondary mb-3">
                                <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#lau-customers">العملاء والديون</a></li>
                                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#lau-products">المنتجات (Inventory)</a></li>
                            </ul>

                            <div class="tab-content">
                                <!-- Customers Tab -->
                                <div class="tab-pane fade show active" id="lau-customers">
                                    <div class="row mb-3">
                                        <div class="col-md-3">
                                            <button class="btn btn-info w-100 fw-bold" onclick="ui.openSimpleDebtModal('laundry')"><i class="fas fa-plus"></i> فاتورة غسيل (دين)</button>
                                        </div>
                                        <div class="col-md-9">
                                            <input type="text" class="form-control" id="laundry-search" placeholder="بحث عن عميل...">
                                        </div>
                                    </div>
                                    <div class="card p-0 overflow-hidden">
                                        <table class="table mb-0">
                                            <thead><tr><th>العميل</th><th>المجموع (USD)</th><th>المجموع (TRY)</th><th>المجموع (SYP)</th><th>الحالة</th><th>إجراء</th></tr></thead>
                                            <tbody id="laundry-customers-list"></tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Products Tab (Re-added) -->
                                <div class="tab-pane fade" id="lau-products">
                                    <button class="btn btn-success mb-3" onclick="ui.openAddProductModal('laundry')">إضافة منتج</button>
                                    <div class="row g-3" id="laundry-products-grid"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 2.1 Customer Profile (Smart View) -->
                        <div id="customer-profile-section" class="app-section">
                            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom border-secondary pb-3">
                                <div>
                                    <button class="btn btn-outline-secondary btn-sm me-2" onclick="router.navigate('laundry')"><i class="fas fa-arrow-right"></i> عودة</button>
                                    <span class="h3 text-warning" id="prof-name">اسم العميل</span>
                                </div>
                                <div class="d-flex gap-2">
                                    <span class="badge bg-dark border border-success d-flex align-items-center">USD: <span id="prof-total-usd" class="ms-1">0</span></span>
                                    <span class="badge bg-dark border border-info d-flex align-items-center">TRY: <span id="prof-total-try" class="ms-1">0</span></span>
                                    <span class="badge bg-dark border border-warning d-flex align-items-center">SYP: <span id="prof-total-syp" class="ms-1">0</span></span>
                                </div>
                            </div>

                            <!-- Smart Actions -->
                            <div class="row g-3 mb-4">
                                <div class="col-md-4">
                                    <div class="card p-3 h-100 border-success">
                                        <h6 class="text-success"><i class="fas fa-check-double"></i> خيار 1: تسديد فواتير محددة</h6>
                                        <p class="small text-muted">اختر منتجات/خدمات من القائمة بالأسفل ثم اضغط هنا.</p>
                                        <button class="btn btn-success w-100" onclick="dataManager.paySelectedItems()">دفع المحدد (توليد فاتورة)</button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card p-3 h-100 border-info">
                                        <h6 class="text-info"><i class="fas fa-hand-holding-usd"></i> خيار 2: تسديد دفعة (Lump Sum)</h6>
                                        <p class="small text-muted">أدخل مبلغاً وسيتم خصمه من أقدم الديون (FIFO).</p>
                                        <button class="btn btn-info w-100" onclick="ui.openLumpSumModal()">إجراء دفعة</button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card p-3 h-100 border-secondary">
                                        <h6 class="text-white"><i class="fas fa-filter"></i> الفلترة والأرشيف</h6>
                                        <div class="d-flex gap-2 mb-2">
                                            <button class="btn btn-sm btn-outline-light flex-fill" onclick="ui.toggleArchive(false)" id="btn-show-active">النشط</button>
                                            <button class="btn btn-sm btn-outline-secondary flex-fill" onclick="ui.toggleArchive(true)" id="btn-show-all">الأرشيف (الكل)</button>
                                        </div>
                                        <input type="text" class="form-control form-control-sm" id="date-filter" placeholder="من تاريخ - إلى تاريخ">
                                    </div>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead><tr>
                                        <th style="width: 40px;"><input type="checkbox" class="form-check-input" id="check-all" onclick="ui.toggleCheckAll()"></th>
                                        <th>التاريخ</th>
                                        <th>الوصف / المنتج</th>
                                        <th>القيمة</th>
                                        <th>العملة</th>
                                        <th>الحالة</th>
                                    </tr></thead>
                                    <tbody id="profile-debts-list"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 3. Espresso Section -->
                        <div id="espresso-section" class="app-section">
                            <h3 class="text-warning mb-4"><i class="fas fa-coffee"></i> الأسبريسو</h3>
                            <ul class="nav nav-tabs border-secondary mb-3">
                                <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#esp-debts">الديون</a></li>
                                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#esp-prods">المنتجات</a></li>
                            </ul>
                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="esp-debts">
                                    <button class="btn btn-warning text-dark fw-bold mb-3" onclick="ui.openSimpleDebtModal('espresso')">دين جديد</button>
                                    <div class="table-responsive"><table class="table"><tbody id="espresso-list"></tbody></table></div>
                                </div>
                                <div class="tab-pane fade" id="esp-prods">
                                    <button class="btn btn-success mb-3" onclick="ui.openAddProductModal('espresso')">إضافة منتج</button>
                                    <div class="row g-3" id="espresso-products-grid"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 4. Finance Section -->
                        <div id="finance-section" class="app-section">
                            <h3 class="mb-4">المالية والتقارير</h3>
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <button class="btn btn-danger w-100" onclick="ui.openTransactionModal('expense')">تسجيل مصروف</button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-success w-100" onclick="ui.openTransactionModal('income_manual')">تسجيل دخل خارجي</button>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <select class="form-select" id="report-type">
                                            <option value="today">يومي</option>
                                            <option value="week">أسبوعي</option>
                                            <option value="year">سنوي</option>
                                            <option value="custom">مخصص (اختر التاريخ)</option>
                                        </select>
                                        <input type="text" class="form-control d-none" id="report-date-range" placeholder="التاريخ">
                                        <button class="btn btn-primary" onclick="reportManager.generatePDF()"><i class="fas fa-file-pdf"></i> تصدير تقرير</button>
                                    </div>
                                </div>
                            </div>
                            <div class="card p-0"><table class="table mb-0"><thead><tr><th>التاريخ</th><th>النوع</th><th>الوصف</th><th>المبلغ</th><th>العملة</th></tr></thead><tbody id="finance-list"></tbody></table></div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- 1. Simple Debt Modal (Used for Laundry & Espresso) -->
    <div class="modal fade" id="simpleDebtModal"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">إضافة</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="simpleDebtForm">
        <input type="hidden" id="sim-source">
        <div class="mb-2"><label>العميل</label><input class="form-control" id="sim-cust" required list="cust-datalist"><datalist id="cust-datalist"></datalist></div>
        <div class="mb-2"><label>الوصف (المنتج/الخدمة)</label><input class="form-control" id="sim-desc" required></div>
        <div class="row mb-2"><div class="col"><input type="number" class="form-control" id="sim-amount" placeholder="المبلغ" step="0.5" required></div><div class="col"><select class="form-select" id="sim-curr"><option value="TRY">TRY</option><option value="USD">USD</option><option value="SYP">SYP</option></select></div></div>
        <button class="btn btn-primary w-100">حفظ</button>
    </form></div></div></div></div>

    <!-- 2. Lump Sum Modal -->
    <div class="modal fade" id="lumpSumModal"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">تسديد دفعة (Lump Sum)</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
        <div class="alert alert-info small">سيتم خصم المبلغ من أقدم الفواتير النشطة تلقائياً (FIFO).</div>
        <form id="lumpSumForm">
            <div class="mb-3"><label>العملة</label><select class="form-select" id="lump-curr"><option value="TRY">TRY</option><option value="USD">USD</option><option value="SYP">SYP</option></select></div>
            <div class="mb-3"><label>المبلغ المدفوع</label><input type="number" class="form-control" id="lump-amount" required step="0.5"></div>
            <button class="btn btn-info w-100">تأكيد الدفع وتوليد الوصل</button>
        </form>
    </div></div></div></div>

    <!-- 3. Add Product Modal -->
    <div class="modal fade" id="addProductModal"><div class="modal-dialog"><div class="modal-content"><div class="modal-body"><form id="addProductForm">
        <input type="hidden" id="prod-cat">
        <input class="form-control mb-2" id="prod-name" placeholder="اسم المنتج" required>
        <div class="row mb-2"><div class="col"><input type="number" class="form-control" id="prod-price" placeholder="السعر" required></div><div class="col"><select class="form-select" id="prod-curr"><option value="TRY">TRY</option><option value="USD">USD</option></select></div></div>
        <input type="file" class="form-control mb-2" id="prod-img">
        <button class="btn btn-success w-100">إضافة</button>
    </form></div></div></div></div>

    <!-- 4. Finance Modal -->
    <div class="modal fade" id="financeModal"><div class="modal-dialog"><div class="modal-content"><div class="modal-body"><form id="financeForm">
        <input type="hidden" id="fin-type">
        <input class="form-control mb-2" id="fin-desc" placeholder="الوصف" required>
        <div class="row mb-2"><div class="col"><input type="number" class="form-control" id="fin-amount" placeholder="المبلغ" required></div><div class="col"><select class="form-select" id="fin-curr"><option value="TRY">TRY</option><option value="USD">USD</option><option value="SYP">SYP</option></select></div></div>
        <button class="btn btn-primary w-100">حفظ</button>
    </form></div></div></div></div>

    <!-- PDF Logic: Invisible Container for rendering -->
    <div id="pdf-container" style="position:fixed; top:-9999px; left:-9999px;"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, getDoc, onSnapshot, serverTimestamp, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {  
            apiKey: "AIzaSyDkJMYhBvNCbjBPlidUW4y1YEkJIkUXvck",  
            authDomain: "mghsalt-shabab-maarra.firebaseapp.com",  
            projectId: "mghsalt-shabab-maarra",  
            storageBucket: "mghsalt-shabab-maarra.firebasestorage.app",  
            messagingSenderId: "89159652894",  
            appId: "1:89159652894:web:c2a88017020777617e000f"  
        };
        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/drielwabh/image/upload";
        const CLOUDINARY_PRESET = "mghsala_upload";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'maarra-v4';

        let allDebts = [];
        let allTrans = [];
        let currentProfileName = '';
        let showArchive = false;

        // --- Data Layer ---
        const dataManager = {
            init: () => {
                // Debts
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'debts'), snap => {
                    allDebts = [];
                    const custSet = new Set();
                    snap.forEach(d => {
                        const data = d.data();
                        allDebts.push({id: d.id, ...data});
                        if(data.source === 'laundry') custSet.add(data.customer_name);
                    });
                    ui.renderLaundryCustomers(Array.from(custSet));
                    ui.renderEspresso();
                    ui.updateDash();
                    ui.updateDatalist(Array.from(custSet));
                    if(currentProfileName) ui.openCustomerProfile(currentProfileName);
                });

                // Transactions
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), snap => {
                    allTrans = [];
                    snap.forEach(d => allTrans.push({id: d.id, ...d.data()}));
                    ui.renderFinance();
                });

                // Products
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'products'), snap => {
                    const prods = [];
                    snap.forEach(d => prods.push(d.data()));
                    ui.renderProducts(prods);
                });
            },

            addDebt: async (data) => {
                showLoading(true);
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'debts'), {
                        ...data, status: 'active', paid_amount: 0, remaining_amount: data.total_amount, created_at: serverTimestamp()
                    });
                    toast("تمت الإضافة");
                    bootstrap.Modal.getInstance(document.getElementById('simpleDebtModal')).hide();
                } catch(e) { toast("خطأ", 'err'); } finally { showLoading(false); }
            },

            // Option 1: Pay Selected
            paySelectedItems: async () => {
                const checked = document.querySelectorAll('.debt-check:checked');
                if(checked.length === 0) return toast("اختر عنصر واحد على الأقل", 'err');

                showLoading(true);
                let totalPaid = 0;
                let itemsDesc = [];
                let currency = '';

                try {
                    for(const box of checked) {
                        const debtId = box.value;
                        const debt = allDebts.find(d => d.id === debtId);
                        currency = debt.currency; // Assume same currency for simplicity/validation
                        
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'debts', debtId), {
                            status: 'paid', remaining_amount: 0, paid_amount: debt.total_amount, paid_at: serverTimestamp()
                        });
                        
                        totalPaid += Number(debt.remaining_amount);
                        itemsDesc.push(`${debt.description} (${debt.total_amount})`);
                    }

                    // Transaction
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
                        type: 'income', source: 'laundry_payment', 
                        description: `تسديد محدد للعميل ${currentProfileName}`, 
                        amount: totalPaid, currency: currency, created_at: serverTimestamp()
                    });

                    toast("تم السداد والأرشفة");
                    reportManager.generateInvoicePDF(currentProfileName, itemsDesc, totalPaid, currency);

                } catch(e) { toast("حدث خطأ", 'err'); console.log(e); } 
                finally { showLoading(false); }
            },

            // Option 2: Lump Sum (FIFO)
            payLumpSum: async (amount, currency) => {
                // Get active debts for this customer & currency, sorted by oldest
                let debts = allDebts.filter(d => 
                    d.customer_name === currentProfileName && 
                    d.source === 'laundry' && 
                    d.currency === currency && 
                    d.status === 'active'
                ).sort((a,b) => (a.created_at?.seconds || 0) - (b.created_at?.seconds || 0));

                if(debts.length === 0) return toast("لا يوجد ديون نشطة بهذه العملة", 'err');

                showLoading(true);
                let remainingPayment = Number(amount);
                let paidItems = [];

                try {
                    for(const debt of debts) {
                        if(remainingPayment <= 0) break;

                        const debtRem = Number(debt.remaining_amount);
                        let payVal = 0;

                        if(remainingPayment >= debtRem) {
                            // Pay Full
                            payVal = debtRem;
                            remainingPayment -= debtRem;
                            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'debts', debt.id), {
                                status: 'paid', remaining_amount: 0, paid_amount: Number(debt.total_amount), paid_at: serverTimestamp()
                            });
                        } else {
                            // Partial
                            payVal = remainingPayment;
                            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'debts', debt.id), {
                                remaining_amount: debtRem - remainingPayment,
                                paid_amount: Number(debt.paid_amount) + remainingPayment
                            });
                            remainingPayment = 0;
                        }
                        paidItems.push(debt);
                    }

                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
                        type: 'income', source: 'lump_sum', 
                        description: `دفعة مقطوعة من ${currentProfileName}`, 
                        amount: Number(amount), currency: currency, created_at: serverTimestamp()
                    });

                    toast("تم تسجيل الدفعة");
                    bootstrap.Modal.getInstance(document.getElementById('lumpSumModal')).hide();
                    
                    // Calc total remaining debt for receipt
                    const newTotal = allDebts
                        .filter(d => d.customer_name === currentProfileName && d.currency === currency && d.status === 'active')
                        .reduce((sum, d) => sum + (d.remaining_amount - (paidItems.find(x=>x.id==d.id)?.remaining_amount || 0)), 0); // Simplified approx for PDF
                    
                    reportManager.generateReceiptPDF(currentProfileName, amount, currency);

                } catch(e) { console.log(e); toast("خطأ", 'err'); }
                finally { showLoading(false); }
            }
        };

        // --- UI Logic ---
        const ui = {
            renderLaundryCustomers: (names) => {
                const tbody = document.getElementById('laundry-customers-list');
                const search = document.getElementById('laundry-search').value.toLowerCase();
                tbody.innerHTML = '';

                names.forEach(name => {
                    if(search && !name.toLowerCase().includes(search)) return;
                    
                    const custDebts = allDebts.filter(d => d.customer_name === name && d.source === 'laundry' && d.status === 'active');
                    let usd = 0, tryVal = 0, syp = 0;
                    custDebts.forEach(d => {
                        if(d.currency === 'USD') usd += d.remaining_amount;
                        if(d.currency === 'TRY') tryVal += d.remaining_amount;
                        if(d.currency === 'SYP') syp += d.remaining_amount;
                    });

                    tbody.innerHTML += `
                        <tr class="customer-row" onclick="ui.openCustomerProfile('${name}')">
                            <td class="fw-bold text-white">${name}</td>
                            <td class="text-usd">${usd}</td>
                            <td class="text-try">${tryVal}</td>
                            <td class="text-syp">${syp}</td>
                            <td>${custDebts.length > 0 ? '<span class="badge bg-danger">عليه دين</span>' : '<span class="badge bg-success">بريء الذمة</span>'}</td>
                            <td><button class="btn btn-sm btn-outline-info">ملف العميل</button></td>
                        </tr>
                    `;
                });
            },

            openCustomerProfile: (name) => {
                currentProfileName = name;
                document.getElementById('prof-name').innerText = name;
                
                const debts = allDebts.filter(d => d.customer_name === name && d.source === 'laundry');
                
                // Calc Totals
                let tUsd=0, tTry=0, tSyp=0;
                debts.filter(d => d.status === 'active').forEach(d => {
                    if(d.currency === 'USD') tUsd += Number(d.remaining_amount);
                    if(d.currency === 'TRY') tTry += Number(d.remaining_amount);
                    if(d.currency === 'SYP') tSyp += Number(d.remaining_amount);
                });
                document.getElementById('prof-total-usd').innerText = tUsd;
                document.getElementById('prof-total-try').innerText = tTry;
                document.getElementById('prof-total-syp').innerText = tSyp;

                // Render List
                const tbody = document.getElementById('profile-debts-list');
                tbody.innerHTML = '';
                
                // Filter Logic
                const dateFilter = document.getElementById('date-filter').value;
                let filtered = debts;
                if(!showArchive) filtered = filtered.filter(d => d.status === 'active');
                
                // Sort
                filtered.sort((a,b) => (b.created_at?.seconds||0) - (a.created_at?.seconds||0));

                filtered.forEach(d => {
                    const isPaid = d.status === 'paid';
                    tbody.innerHTML += `
                        <tr class="${isPaid ? 'opacity-50' : ''}">
                            <td>${!isPaid ? `<input type="checkbox" class="form-check-input debt-check" value="${d.id}">` : '<i class="fas fa-check text-success"></i>'}</td>
                            <td>${new Date(d.created_at?.seconds*1000).toLocaleDateString('ar-EG')}</td>
                            <td>${d.description}</td>
                            <td class="fw-bold">${d.remaining_amount} / ${d.total_amount}</td>
                            <td>${d.currency}</td>
                            <td>${isPaid ? '<span class="badge bg-success">خالص</span>' : '<span class="badge bg-warning text-dark">نشط</span>'}</td>
                        </tr>
                    `;
                });

                router.navigate('customer-profile');
            },

            // --- Modals ---
            openSimpleDebtModal: (src) => {
                document.getElementById('simpleDebtForm').reset();
                document.getElementById('sim-source').value = src;
                new bootstrap.Modal(document.getElementById('simpleDebtModal')).show();
            },
            openLumpSumModal: () => new bootstrap.Modal(document.getElementById('lumpSumModal')).show(),
            openAddProductModal: (cat) => {
                document.getElementById('addProductForm').reset();
                document.getElementById('prod-cat').value = cat;
                new bootstrap.Modal(document.getElementById('addProductModal')).show();
            },
            openTransactionModal: (type) => {
                document.getElementById('financeForm').reset();
                document.getElementById('fin-type').value = type;
                new bootstrap.Modal(document.getElementById('financeModal')).show();
            },

            // --- Helpers ---
            updateDash: () => {
                let u=0, t=0, s=0;
                allDebts.filter(d => d.status === 'active').forEach(d => {
                    if(d.currency === 'USD') u+=d.remaining_amount;
                    if(d.currency === 'TRY') t+=d.remaining_amount;
                    if(d.currency === 'SYP') s+=d.remaining_amount;
                });
                document.getElementById('dash-usd').innerText = u + ' $';
                document.getElementById('dash-try').innerText = t + ' ₺';
                document.getElementById('dash-syp').innerText = s;
            },
            updateDatalist: (names) => {
                const dl = document.getElementById('cust-datalist');
                dl.innerHTML = ''; names.forEach(n => dl.innerHTML += `<option value="${n}">`);
            },
            toggleArchive: (state) => {
                showArchive = state;
                document.getElementById('btn-show-active').classList.toggle('btn-light', !state);
                document.getElementById('btn-show-active').classList.toggle('btn-outline-light', state);
                document.getElementById('btn-show-all').classList.toggle('btn-light', state);
                document.getElementById('btn-show-all').classList.toggle('btn-outline-secondary', !state);
                ui.openCustomerProfile(currentProfileName);
            },
            toggleCheckAll: () => {
                const master = document.getElementById('check-all').checked;
                document.querySelectorAll('.debt-check').forEach(c => c.checked = master);
            },

            // --- Render Other Sections ---
            renderEspresso: () => {
                const t = document.getElementById('espresso-list'); t.innerHTML='';
                allDebts.filter(d=>d.source==='espresso' && d.status==='active').forEach(d=>{
                    t.innerHTML += `<tr><td>${d.customer_name}</td><td>${d.description}</td><td>${d.remaining_amount} ${d.currency}</td></tr>`;
                });
            },
            renderProducts: (list) => {
                const lg = document.getElementById('laundry-products-grid'); lg.innerHTML='';
                const eg = document.getElementById('espresso-products-grid'); eg.innerHTML='';
                
                list.forEach(p => {
                    const html = `<div class="col-6 col-md-3"><div class="card p-2 text-center h-100"><img src="${p.image_url}" class="img-fluid rounded mb-2" style="height:100px;object-fit:cover;"><h6>${p.name}</h6><span class="text-info">${p.selling_price} ${p.currency}</span></div></div>`;
                    if(p.category==='laundry') lg.innerHTML += html; else eg.innerHTML += html;
                });
            },
            renderFinance: () => {
                const t = document.getElementById('finance-list'); t.innerHTML='';
                allTrans.sort((a,b)=>b.created_at?.seconds-a.created_at?.seconds).slice(0,50).forEach(tr => {
                    t.innerHTML += `<tr><td>${new Date(tr.created_at?.seconds*1000).toLocaleDateString('ar-EG')}</td><td>${tr.type.includes('income')?'<span class="text-success">دخل</span>':'<span class="text-danger">صرف</span>'}</td><td>${tr.description}</td><td class="fw-bold">${tr.amount} ${tr.currency}</td></tr>`;
                });
            }
        };

        // --- Report Manager (PDF) ---
        window.reportManager = {
            generateInvoicePDF: (name, items, total, curr) => {
                const doc = new jspdf.jsPDF({ align: 'right' });
                // Use html2canvas or simple text for now since Arabic fonts are tricky in pure JS
                // Simplified Receipt
                doc.setFontSize(22); doc.text("Laundry Receipt", 105, 20, "center");
                doc.setFontSize(16); doc.text(`Customer: ${name}`, 180, 40, "right");
                doc.text(`Date: ${new Date().toLocaleDateString()}`, 180, 50, "right");
                
                let y = 70;
                items.forEach(i => { doc.text(`- ${i}`, 180, y, "right"); y+=10; });
                
                doc.setLineWidth(0.5); doc.line(20, y+5, 190, y+5);
                doc.setFontSize(20); doc.text(`Total Paid: ${total} ${curr}`, 180, y+20, "right");
                doc.save(`Invoice_${name}.pdf`);
            },

            generateReceiptPDF: (name, amount, curr) => {
                const doc = new jspdf.jsPDF();
                doc.text("Payment Receipt", 105, 20, "center");
                doc.text(`Customer: ${name}`, 20, 40);
                doc.text(`Amount Paid: ${amount} ${curr}`, 20, 50);
                doc.text(`Type: Account Payment (Lump Sum)`, 20, 60);
                doc.text(`Date: ${new Date().toLocaleString()}`, 20, 70);
                doc.save(`Receipt_${name}.pdf`);
            },

            generatePDF: () => {
                const type = document.getElementById('report-type').value;
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                let filtered = allTrans;
                const now = new Date();
                
                if(type === 'today') filtered = allTrans.filter(t => new Date(t.created_at.seconds*1000).setHours(0,0,0,0) === now.setHours(0,0,0,0));
                else if(type === 'week') {
                    const lastWeek = new Date(now.setDate(now.getDate() - 7));
                    filtered = allTrans.filter(t => new Date(t.created_at.seconds*1000) > lastWeek);
                }
                
                const tableData = filtered.map(t => [
                    t.currency,
                    t.amount,
                    t.description, // Arabic text might show reversed in standard jspdf without custom font
                    t.type,
                    new Date(t.created_at.seconds*1000).toLocaleDateString()
                ]);

                doc.autoTable({
                    head: [['Currency', 'Amount', 'Desc', 'Type', 'Date']],
                    body: tableData,
                });
                doc.save('Finance_Report.pdf');
            }
        };

        // --- Event Listeners ---
        document.getElementById('laundry-search').addEventListener('keyup', () => ui.renderLaundryCustomers(Array.from(new Set(allDebts.filter(d=>d.source==='laundry').map(d=>d.customer_name)))));
        document.getElementById('report-type').addEventListener('change', (e) => {
            document.getElementById('report-date-range').classList.toggle('d-none', e.target.value !== 'custom');
        });
        
        // Forms
        document.getElementById('simpleDebtForm').addEventListener('submit', e => {
            e.preventDefault(); dataManager.addDebt({
                customer_name: document.getElementById('sim-cust').value,
                description: document.getElementById('sim-desc').value,
                total_amount: Number(document.getElementById('sim-amount').value),
                currency: document.getElementById('sim-curr').value,
                source: document.getElementById('sim-source').value
            });
        });

        document.getElementById('lumpSumForm').addEventListener('submit', e => {
            e.preventDefault(); dataManager.payLumpSum(document.getElementById('lump-amount').value, document.getElementById('lump-curr').value);
        });

        document.getElementById('financeForm').addEventListener('submit', async e => {
            e.preventDefault();
            await addDoc(collection(db,'artifacts',appId,'public','data','transactions'),{
                type: document.getElementById('fin-type').value,
                description: document.getElementById('fin-desc').value,
                amount: Number(document.getElementById('fin-amount').value),
                currency: document.getElementById('fin-curr').value,
                created_at: serverTimestamp()
            });
            bootstrap.Modal.getInstance(document.getElementById('financeModal')).hide(); toast("تم");
        });

        document.getElementById('loginForm').addEventListener('submit', async e => {
            e.preventDefault(); showLoading(true);
            try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); } 
            catch { toast("فشل الدخول",'err'); showLoading(false); }
        });

        const upload = async (file) => {
            const fd = new FormData(); fd.append('file', file); fd.append('upload_preset', CLOUDINARY_PRESET);
            return (await (await fetch(CLOUDINARY_URL, {method:'POST', body:fd})).json()).secure_url;
        }

        document.getElementById('addProductForm').addEventListener('submit', async e => {
            e.preventDefault(); showLoading(true);
            const url = await upload(document.getElementById('prod-img').files[0]);
            await addDoc(collection(db,'artifacts',appId,'public','data','products'),{
                name: document.getElementById('prod-name').value, category: document.getElementById('prod-cat').value,
                selling_price: document.getElementById('prod-price').value, currency: document.getElementById('prod-curr').value, image_url: url
            });
            showLoading(false); toast("تم"); bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
        });

        // Auth
        onAuthStateChanged(auth, u => {
            showLoading(false);
            if(u) {
                document.getElementById('login-screen').classList.add('d-none');
                document.getElementById('main-app').classList.remove('d-none');
                dataManager.init();
                flatpickr("#report-date-range", {mode: "range"});
                flatpickr("#date-filter", {mode: "range", onChange: () => ui.openCustomerProfile(currentProfileName)});
            } else {
                document.getElementById('login-screen').classList.remove('d-none');
                document.getElementById('main-app').classList.add('d-none');
            }
        });

        // Globals
        window.router = { navigate: id => {
            document.querySelectorAll('.app-section').forEach(s => s.classList.remove('active-section'));
            document.getElementById(id+'-section').classList.add('active-section');
        }};
        window.ui = ui; window.dataManager = dataManager; window.reportManager = reportManager; window.auth = auth;
        const toast = (m,t) => Toastify({text:m, style:{background:t=='err'?'#f87171':'#4ade80'}, duration:2000}).showToast();
        const showLoading = s => document.getElementById('loading-overlay').classList.toggle('d-none', !s);
    </script>
</body>
    </html>
