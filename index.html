<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مغسلة شباب المعرة - النظام الإداري</title>
    
    <!-- Bootstrap 5 RTL & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <!-- Toastify -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <style>
        :root {
           --bg-dark: #121212; /* الخلفية الداكنة */
           --bg-card: #1c1c1c; /* لون الخلفية للبطاقات */
           --bg-sidebar: #212121; /* خلفية الشريط الجانبي */
           --text-main: #e0e0e0; /* النص الرئيسي */
           --text-muted: #b0b0b0; /* النص الخافت */
           --primary: #607d8b; /* اللون الأساسي (أزرق رمادي) */
           --accent: #26c6da; /* اللون المميز (أزرق مائل للأخضر) */
           --success: #4caf50; /* اللون للدلالة على النجاح */
           --danger: #f44336; /* اللون للدلالة على الخطأ */
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            overflow-x: hidden;
        }

        /* Dark Mode Overrides */
        .card { background-color: var(--bg-card); border: 1px solid #333; color: var(--text-main); }
        .form-control, .form-select { background-color: #2d2d2d; border: 1px solid #444; color: white; }
        .form-control:focus, .form-select:focus { background-color: #333; color: white; border-color: var(--primary); box-shadow: none; }
        .table { color: var(--text-main); }
        .table thead th { background-color: #252525; border-bottom: 2px solid #444; color: var(--accent); }
        .table-hover tbody tr:hover { color: white; background-color: #2c2c2c; }
        .modal-content { background-color: var(--bg-card); border: 1px solid #444; }
        .btn-close { filter: invert(1); }
        .border-bottom { border-color: #333 !important; }

        /* Sidebar */
        .sidebar { min-height: 100vh; background-color: var(--bg-sidebar); border-left: 1px solid #333; }
        .nav-link { color: var(--text-muted); padding: 12px 15px; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; }
        .nav-link:hover, .nav-link.active { background-color: rgba(63, 81, 181, 0.2); color: var(--accent); font-weight: bold; }
        .nav-link i { width: 25px; text-align: center; }

        /* Custom UI */
        .app-section { display: none; animation: fadeIn 0.3s; }
        .app-section.active-section { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .stat-card { background: #252525; border-radius: 12px; padding: 20px; position: relative; overflow: hidden; }
        .stat-card::after { content: ''; position: absolute; top: 0; right: 0; width: 4px; height: 100%; }
        .stat-usd::after { background-color: var(--success); }
        .stat-try::after { background-color: var(--accent); }
        
        .customer-row { cursor: pointer; transition: 0.2s; }
        .customer-row:hover { background-color: #2a2a2a; }

        /* Invoice Items in Modal */
        .invoice-item-row { background: #2a2a2a; padding: 10px; border-radius: 5px; margin-bottom: 5px; border: 1px solid #444; }

        /* Print Area (Hidden by default) */
        #print-area { display: none; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { display: block; position: absolute; left: 0; top: 0; width: 100%; color: black; background: white; padding: 20px; }
            .no-print { display: none !important; }
        }

        .loading-overlay { position: fixed; inset: 0; background: rgba(18,18,18,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

    <!-- Loading -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner-border text-info mb-3" role="status"></div>
        <h6 class="text-white">جاري الاتصال بالنظام...</h6>
    </div>

    <!-- Login -->
    <div id="login-screen" class="d-none">
        <div class="container h-100 d-flex justify-content-center align-items-center" style="min-height: 100vh;">
            <div class="card p-5 shadow-lg border-0" style="width: 400px; max-width: 90%; background: #1a1a1a;">
                <div class="text-center mb-4">
                    <i class="fas fa-soap fa-3x text-info mb-3"></i>
                    <h3 class="fw-bold text-white">مغسلة شباب المعرة</h3>
                    <p class="text-muted">تسجيل دخول الإدارة</p>
                </div>
                <form id="loginForm">
                    <div class="mb-3">
                        <input type="email" id="email" class="form-control py-2" placeholder="البريد الإلكتروني" required>
                    </div>
                    <div class="mb-4">
                        <input type="password" id="password" class="form-control py-2" placeholder="كلمة المرور" required>
                    </div>
                    <button type="submit" class="btn btn-info w-100 fw-bold py-2">دخول</button>
                    <div id="login-error" class="text-danger mt-3 text-center small fw-bold"></div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="d-none">
        <div class="container-fluid p-0">
            <div class="row g-0">
                <!-- Sidebar -->
                <div class="col-md-2 sidebar p-3 d-none d-md-block">
                    <h5 class="text-center text-white mb-5 mt-2 border-bottom border-secondary pb-3">
                        لوحة التحكم
                    </h5>
                    <nav class="nav flex-column gap-2">
                        <a class="nav-link active" onclick="router.navigate('dashboard')"><i class="fas fa-chart-line"></i> نظرة عامة</a>
                        <a class="nav-link" onclick="router.navigate('laundry')"><i class="fas fa-tshirt"></i> قسم المغسلة</a>
                        <a class="nav-link" onclick="router.navigate('espresso')"><i class="fas fa-coffee"></i> قسم الأسبريسو</a>
                        <a class="nav-link" onclick="router.navigate('employees')"><i class="fas fa-users-cog"></i> الموظفين</a>
                        <a class="nav-link" onclick="router.navigate('finance')"><i class="fas fa-wallet"></i> المالية</a>
                        <a class="nav-link text-danger mt-5" onclick="authManager.logout()"><i class="fas fa-sign-out-alt"></i> خروج</a>
                    </nav>
                </div>

                <!-- Content -->
                <div class="col-md-10" style="height: 100vh; overflow-y: auto;">
                    <!-- Mobile Nav -->
                    <div class="d-md-none bg-dark p-3 d-flex justify-content-between align-items-center border-bottom border-secondary">
                        <span class="fw-bold text-white">مغسلة شباب المعرة</span>
                        <button class="btn btn-sm btn-outline-light" data-bs-toggle="collapse" data-bs-target="#mobileMenu"><i class="fas fa-bars"></i></button>
                    </div>
                    <div class="collapse d-md-none bg-dark" id="mobileMenu">
                        <div class="p-2 d-grid gap-2">
                            <button class="btn btn-dark text-end" onclick="router.navigate('dashboard')">الرئيسية</button>
                            <button class="btn btn-dark text-end" onclick="router.navigate('laundry')">المغسلة</button>
                            <button class="btn btn-dark text-end" onclick="router.navigate('espresso')">الأسبريسو</button>
                            <button class="btn btn-dark text-end" onclick="router.navigate('finance')">المالية</button>
                            <button class="btn btn-danger text-end" onclick="authManager.logout()">خروج</button>
                        </div>
                    </div>

                    <div class="p-4">
                        
                        <!-- 1. Dashboard -->
                        <div id="dashboard-section" class="app-section active-section">
                            <h3 class="mb-4 text-white">ملخص العمل</h3>
                            <div class="row g-4">
                                <div class="col-md-4">
                                    <div class="stat-card stat-usd">
                                        <h6 class="text-muted">الديون المستحقة (USD)</h6>
                                        <h2 class="fw-bold text-white mt-2" id="dash-usd">0 $</h2>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="stat-card stat-try">
                                        <h6 class="text-muted">الديون المستحقة (TRY)</h6>
                                        <h2 class="fw-bold text-white mt-2" id="dash-try">0 ₺</h2>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="stat-card">
                                        <h6 class="text-muted">عدد الفواتير النشطة</h6>
                                        <h2 class="fw-bold text-info mt-2" id="dash-count">0</h2>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 2. Laundry Section (Core) -->
                        <div id="laundry-section" class="app-section">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h3 class="text-info"><i class="fas fa-tshirt"></i> إدارة المغسلة</h3>
                                <button class="btn btn-info fw-bold" onclick="uiManager.openInvoiceModal()"><i class="fas fa-plus"></i> فاتورة غسيل جديدة</button>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="laundry-search" placeholder="بحث عن عميل...">
                                </div>
                            </div>

                            <div class="card p-0 overflow-hidden">
                                <table class="table mb-0 align-middle">
                                    <thead><tr><th>العميل</th><th>آخر فاتورة</th><th>إجمالي المتبقي</th><th>العملة</th><th>الحالة</th><th>إجراء</th></tr></thead>
                                    <tbody id="laundry-customers-list"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 2.1 Customer Profile View (Sub-section) -->
                        <div id="customer-profile-section" class="app-section">
                            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom border-secondary pb-3">
                                <div>
                                    <button class="btn btn-outline-light btn-sm me-2" onclick="router.navigate('laundry')"><i class="fas fa-arrow-right"></i> عودة</button>
                                    <span class="h4 text-warning" id="profile-name">اسم العميل</span>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-danger fs-6">المتبقي: <span id="profile-total-debt">0</span> <span id="profile-currency"></span></span>
                                </div>
                            </div>

                            <h5 class="text-muted mb-3">سجل الفواتير</h5>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead><tr><th>التاريخ</th><th>التفاصيل/المنتجات</th><th>القيمة الكلية</th><th>المدفوع</th><th>المتبقي</th><th>الحالة</th><th>خيارات</th></tr></thead>
                                    <tbody id="profile-invoices-list"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 3. Espresso Section -->
                        <div id="espresso-section" class="app-section">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h3 class="text-warning"><i class="fas fa-coffee"></i> الأسبريسو</h3>
                            </div>
                            <ul class="nav nav-tabs border-secondary mb-3">
                                <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#esp-debts">الطلبات والديون</a></li>
                                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#esp-prods">المنتجات</a></li>
                            </ul>
                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="esp-debts">
                                    <button class="btn btn-warning text-dark fw-bold mb-3" onclick="uiManager.openSimpleDebtModal('espresso')"><i class="fas fa-plus"></i> دين جديد</button>
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead><tr><th>العميل</th><th>الوصف</th><th>المبلغ</th><th>العملة</th><th>إجراء</th></tr></thead>
                                            <tbody id="espresso-table"></tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="esp-prods">
                                    <button class="btn btn-success mb-3" onclick="uiManager.openAddProductModal('espresso')">إضافة منتج</button>
                                    <div class="row g-3" id="espresso-grid"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 4. Employees Section -->
                        <div id="employees-section" class="app-section">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h3 class="text-white"><i class="fas fa-users"></i> الموظفين</h3>
                                <button class="btn btn-light" onclick="uiManager.openAddEmployeeModal()">إضافة موظف</button>
                            </div>
                            <div class="card p-0">
                                <table class="table mb-0 align-middle">
                                    <thead><tr><th>الاسم</th><th>الراتب الأساسي</th><th>الصافي المستحق</th><th>العملة</th><th>إجراءات</th></tr></thead>
                                    <tbody id="employees-table"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 5. Finance Section -->
                        <div id="finance-section" class="app-section">
                            <h3 class="mb-4 text-success">المالية والتقارير</h3>
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <button class="btn btn-danger w-100 py-3 mb-2" onclick="uiManager.openTransactionModal('expense')"><i class="fas fa-arrow-down"></i> تسجيل مصروف</button>
                                </div>
                                <div class="col-md-6">
                                    <button class="btn btn-success w-100 py-3" onclick="uiManager.openTransactionModal('income_manual')"><i class="fas fa-arrow-up"></i> تسجيل دخل خارجي</button>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header bg-dark border-bottom border-secondary d-flex justify-content-between">
                                    <span>سجل المعاملات (الدخل والمصروف)</span>
                                </div>
                                <div class="card-body p-0">
                                    <table class="table table-striped mb-0">
                                        <thead><tr><th>التاريخ</th><th>النوع</th><th>الوصف</th><th>المبلغ</th><th>العملة</th></tr></thead>
                                        <tbody id="finance-table"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- === MODALS === -->

    <!-- 1. Advanced Laundry Invoice Modal -->
    <div class="modal fade" id="invoiceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-dark border-bottom border-secondary">
                    <h5 class="modal-title text-info">إنشاء فاتورة غسيل مفصلة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="invoiceForm">
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label class="form-label text-muted">اسم العميل (بحث أو جديد)</label>
                                <input type="text" class="form-control" id="inv-customer" list="customer-list-datalist" required autocomplete="off">
                                <datalist id="customer-list-datalist"></datalist>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label text-muted">العملة</label>
                                <select class="form-select" id="inv-currency">
                                    <option value="TRY">ليرة تركي (₺)</option>
                                    <option value="USD">دولار ($)</option>
                                </select>
                            </div>
                        </div>

                        <label class="form-label text-muted">المنتجات والخدمات</label>
                        <div id="invoice-items-container">
                            <!-- Items inserted by JS -->
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm mb-3 w-100" onclick="uiManager.addInvoiceRow()">+ إضافة بند</button>

                        <div class="row border-top border-secondary pt-3">
                            <div class="col-6"><h5 class="text-white">الإجمالي: <span id="inv-total">0</span></h5></div>
                            <div class="col-6 text-end">
                                <button type="submit" class="btn btn-info fw-bold px-4">حفظ الفاتورة</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Payment Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success"><h5 class="modal-title text-white">إجراء دفع</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body text-center">
                    <p class="text-muted">المبلغ المتبقي</p>
                    <h2 class="fw-bold mb-3"><span id="pay-remain">0</span> <small id="pay-curr"></small></h2>
                    <form id="paymentForm">
                        <input type="hidden" id="pay-doc-id">
                        <input type="number" class="form-control fs-4 text-center mb-3" id="pay-amount" placeholder="المبلغ المدفوع" required step="0.1">
                        <button type="submit" class="btn btn-success w-100 fw-bold">تأكيد الدفع</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Employee Action Modal -->
    <div class="modal fade" id="empActionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">إجراء مالي للموظف</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="empActionForm">
                        <input type="hidden" id="act-emp-id">
                        <div class="mb-3">
                            <label class="form-label text-muted">نوع العملية</label>
                            <select class="form-select" id="act-type">
                                <option value="deduction">خصم (عقوبة/غياب)</option>
                                <option value="advance">سلفة (تخصم من الراتب)</option>
                                <option value="bonus">مكافأة (تضاف للراتب)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <input type="number" class="form-control" id="act-amount" placeholder="المبلغ" required>
                        </div>
                        <div class="mb-3">
                            <input type="text" class="form-control" id="act-reason" placeholder="السبب" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">تنفيذ</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. Finance Transaction Modal -->
    <div class="modal fade" id="financeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="fin-modal-title">تسجيل حركة</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="financeForm">
                        <input type="hidden" id="fin-type">
                        <div class="mb-3"><input type="text" class="form-control" id="fin-desc" placeholder="الوصف (مصدر الدخل / سبب الصرف)" required></div>
                        <div class="row mb-3">
                            <div class="col"><input type="number" class="form-control" id="fin-amount" placeholder="المبلغ" required></div>
                            <div class="col">
                                <select class="form-select" id="fin-currency">
                                    <option value="TRY">ليرة (₺)</option>
                                    <option value="USD">دولار ($)</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-light w-100 fw-bold" id="fin-submit-btn">حفظ</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. Add Product/Simple Debt Modals (Simplified for brevity) -->
    <div class="modal fade" id="simpleDebtModal"><div class="modal-dialog"><div class="modal-content"><div class="modal-body"><form id="simpleDebtForm">
        <input type="hidden" id="sim-source">
        <input class="form-control mb-2" id="sim-cust" placeholder="العميل" required>
        <input class="form-control mb-2" id="sim-desc" placeholder="الوصف" required>
        <div class="row mb-2"><div class="col"><input type="number" class="form-control" id="sim-amount" placeholder="المبلغ" required></div><div class="col"><select class="form-select" id="sim-curr"><option value="TRY">TRY</option><option value="USD">USD</option></select></div></div>
        <button class="btn btn-warning w-100">حفظ</button>
    </form></div></div></div></div>

    <div class="modal fade" id="addProductModal"><div class="modal-dialog"><div class="modal-content"><div class="modal-body"><form id="addProductForm">
        <input type="hidden" id="prod-cat">
        <input class="form-control mb-2" id="prod-name" placeholder="اسم المنتج" required>
        <div class="row mb-2"><div class="col"><input type="number" class="form-control" id="prod-price" placeholder="السعر" required></div><div class="col"><select class="form-select" id="prod-curr"><option value="TRY">TRY</option><option value="USD">USD</option></select></div></div>
        <input type="file" class="form-control mb-2" id="prod-img">
        <button class="btn btn-success w-100">إضافة</button>
    </form></div></div></div></div>

    <div class="modal fade" id="addEmpModal"><div class="modal-dialog"><div class="modal-content"><div class="modal-body"><form id="addEmpForm">
        <input class="form-control mb-2" id="emp-name" placeholder="الاسم" required>
        <div class="row mb-2"><div class="col"><input type="number" class="form-control" id="emp-salary" placeholder="الراتب" required></div><div class="col"><select class="form-select" id="emp-curr"><option value="USD">USD</option><option value="TRY">TRY</option></select></div></div>
        <button class="btn btn-light w-100">حفظ</button>
    </form></div></div></div></div>

    <!-- Hidden Print Area -->
    <div id="print-area"></div>

    <!-- Logic -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, getDoc, onSnapshot, serverTimestamp, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {  
            apiKey: "AIzaSyDkJMYhBvNCbjBPlidUW4y1YEkJIkUXvck",  
            authDomain: "mghsalt-shabab-maarra.firebaseapp.com",  
            projectId: "mghsalt-shabab-maarra",  
            storageBucket: "mghsalt-shabab-maarra.firebasestorage.app",  
            messagingSenderId: "89159652894",  
            appId: "1:89159652894:web:c2a88017020777617e000f"  
        };
        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/drielwabh/image/upload";
        const CLOUDINARY_PRESET = "mghsala_upload";
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'maarra-v3';

        let currentUser = null;
        let productsCache = [];
        let customersCache = []; // To store unique names for datalist

        // --- Data Logic ---
        const dataManager = {
            init: () => {
                // Debts & Laundry
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'debts'), snap => {
                    const list = [];
                    const names = new Set();
                    snap.forEach(d => {
                        const data = d.data();
                        list.push({id: d.id, ...data});
                        if(data.source === 'laundry') names.add(data.customer_name);
                    });
                    uiManager.renderLaundryCustomers(list, Array.from(names));
                    uiManager.renderEspresso(list);
                    uiManager.updateStats(list);
                });

                // Transactions
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), snap => {
                    const list = [];
                    snap.forEach(d => list.push(d.data()));
                    uiManager.renderFinance(list);
                });

                // Employees
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'employees'), snap => {
                    const list = [];
                    snap.forEach(d => list.push({id: d.id, ...d.data()}));
                    uiManager.renderEmployees(list);
                });

                // Products
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'products'), snap => {
                    productsCache = [];
                    snap.forEach(d => productsCache.push(d.data()));
                    uiManager.renderProducts(productsCache);
                });
            },

            addInvoice: async (data) => {
                showLoading(true);
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'debts'), {
                        ...data,
                        status: 'active',
                        paid_amount: 0,
                        remaining_amount: data.total_amount,
                        created_at: serverTimestamp(),
                        source: 'laundry'
                    });
                    toast("تم حفظ الفاتورة");
                    bootstrap.Modal.getInstance(document.getElementById('invoiceModal')).hide();
                } catch(e) { toast("خطأ", 'error'); } 
                finally { showLoading(false); }
            },

            addTransaction: async (data) => {
                showLoading(true);
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
                        ...data, created_at: serverTimestamp()
                    });
                    toast("تم التسجيل");
                    bootstrap.Modal.getInstance(document.getElementById('financeModal')).hide();
                } catch(e) { toast("خطأ", 'error'); } 
                finally { showLoading(false); }
            },

            processPayment: async (id, amount) => {
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'debts', id);
                const d = (await getDoc(ref)).data();
                const newRem = Number(d.remaining_amount) - Number(amount);
                
                if(newRem < 0) return toast("المبلغ أكبر من المتبقي", 'error');

                await updateDoc(ref, {
                    paid_amount: Number(d.paid_amount) + Number(amount),
                    remaining_amount: newRem,
                    status: newRem === 0 ? 'paid' : 'active',
                    last_payment: serverTimestamp()
                });

                await dataManager.addTransaction({
                    type: 'income',
                    source: 'payment',
                    description: `سداد فاتورة: ${d.customer_name}`,
                    amount: Number(amount),
                    currency: d.currency
                });
                
                bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                
                // Refresh Profile if open
                if(document.getElementById('customer-profile-section').classList.contains('active-section')) {
                    uiManager.openCustomerProfile(d.customer_name); // Re-fetch logic implied by listeners, but ensures UI sync
                }
            },

            addEmpAction: async (id, type, amount, reason) => {
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'employees', id);
                const emp = (await getDoc(ref)).data();
                let net = Number(emp.net_salary || emp.salary);
                
                if(type === 'bonus') net += Number(amount);
                else net -= Number(amount); // Deduction or Advance

                await updateDoc(ref, { net_salary: net });
                
                // Log as transaction logic could be here, kept simple for now
                toast("تم تنفيذ الإجراء");
                bootstrap.Modal.getInstance(document.getElementById('empActionModal')).hide();
            }
        };

        // --- UI Logic ---
        const uiManager = {
            // -- Invoice Builder --
            openInvoiceModal: () => {
                document.getElementById('invoiceForm').reset();
                document.getElementById('invoice-items-container').innerHTML = '';
                // Populate Datalist
                const dl = document.getElementById('customer-list-datalist');
                dl.innerHTML = '';
                customersCache.forEach(name => dl.innerHTML += `<option value="${name}">`);
                uiManager.addInvoiceRow(); // Add first empty row
                new bootstrap.Modal(document.getElementById('invoiceModal')).show();
            },

            addInvoiceRow: () => {
                const div = document.createElement('div');
                div.className = 'invoice-item-row row g-2';
                // Build product options
                let opts = '<option value="">اختر منتج/خدمة...</option>';
                productsCache.forEach(p => {
                    opts += `<option value="${p.name}" data-price="${p.selling_price}">${p.name} - ${p.selling_price}</option>`;
                });
                
                div.innerHTML = `
                    <div class="col-6"><select class="form-select prod-select" onchange="uiManager.calcTotal()">${opts}</select></div>
                    <div class="col-3"><input type="number" class="form-control prod-qty" placeholder="العدد" value="1" onchange="uiManager.calcTotal()"></div>
                    <div class="col-3"><input type="number" class="form-control prod-price" placeholder="السعر" step="0.5" onchange="uiManager.calcTotal()"></div>
                `;
                
                // Add listener to auto-fill price
                div.querySelector('.prod-select').addEventListener('change', function() {
                    const price = this.options[this.selectedIndex].getAttribute('data-price');
                    if(price) div.querySelector('.prod-price').value = price;
                    uiManager.calcTotal();
                });

                document.getElementById('invoice-items-container').appendChild(div);
            },

            calcTotal: () => {
                let total = 0;
                document.querySelectorAll('.invoice-item-row').forEach(row => {
                    const qty = row.querySelector('.prod-qty').value || 0;
                    const price = row.querySelector('.prod-price').value || 0;
                    total += (qty * price);
                });
                document.getElementById('inv-total').innerText = total;
                return total;
            },

            // -- Customer Profile --
            openCustomerProfile: (name) => {
                const debts = uiManager.allDebts.filter(d => d.customer_name === name && d.source === 'laundry');
                let total = 0;
                let currency = debts[0]?.currency || '';
                
                document.getElementById('profile-name').innerText = name;
                document.getElementById('profile-currency').innerText = currency;
                
                const tbody = document.getElementById('profile-invoices-list');
                tbody.innerHTML = '';
                
                debts.sort((a,b) => b.created_at?.seconds - a.created_at?.seconds).forEach(d => {
                    if(d.status === 'active') total += Number(d.remaining_amount);
                    
                    // Parse Items if available, else description
                    let details = d.description || '';
                    if(d.items && Array.isArray(d.items)) {
                        details = d.items.map(i => `${i.item} (${i.qty}x${i.price})`).join(', ');
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td>${new Date(d.created_at?.seconds * 1000).toLocaleDateString('ar-EG')}</td>
                            <td><small>${details}</small></td>
                            <td>${d.total_amount}</td>
                            <td class="text-success">${d.paid_amount}</td>
                            <td class="text-danger fw-bold">${d.remaining_amount}</td>
                            <td>${d.status === 'paid' ? '<span class="badge bg-success">خالص</span>' : '<span class="badge bg-danger">نشط</span>'}</td>
                            <td>
                                ${d.status !== 'paid' ? `<button class="btn btn-sm btn-outline-success me-1" onclick="uiManager.openPayModal('${d.id}')">دفع</button>` : ''}
                                <button class="btn btn-sm btn-outline-light" onclick="printManager.printInvoice('${d.id}')"><i class="fas fa-print"></i></button>
                            </td>
                        </tr>
                    `;
                });
                document.getElementById('profile-total-debt').innerText = total;
                
                router.navigate('customer-profile');
            },

            // -- Renders --
            renderLaundryCustomers: (list, uniqueNames) => {
                uiManager.allDebts = list; // Cache for profile view
                customersCache = uniqueNames;
                const tbody = document.getElementById('laundry-customers-list');
                tbody.innerHTML = '';

                uniqueNames.forEach(name => {
                    const custDebts = list.filter(d => d.customer_name === name && d.source === 'laundry');
                    if(custDebts.length === 0) return;
                    
                    const activeDebts = custDebts.filter(d => d.status === 'active');
                    const totalRem = activeDebts.reduce((sum, d) => sum + Number(d.remaining_amount), 0);
                    const lastDate = new Date(Math.max(...custDebts.map(d => d.created_at?.seconds * 1000))).toLocaleDateString('ar-EG');
                    const curr = custDebts[0].currency;
                    
                    // Filter search
                    const search = document.getElementById('laundry-search').value.toLowerCase();
                    if(search && !name.toLowerCase().includes(search)) return;

                    tbody.innerHTML += `
                        <tr class="customer-row" onclick="uiManager.openCustomerProfile('${name}')">
                            <td class="fw-bold">${name}</td>
                            <td>${lastDate}</td>
                            <td class="text-warning fw-bold fs-5">${totalRem}</td>
                            <td>${curr}</td>
                            <td>${activeDebts.length > 0 ? '<span class="badge bg-danger">عليه دين</span>' : '<span class="badge bg-success">بريء الذمة</span>'}</td>
                            <td><button class="btn btn-sm btn-outline-info">عرض الملف</button></td>
                        </tr>
                    `;
                });
            },

            renderFinance: (list) => {
                const tbody = document.getElementById('finance-table');
                tbody.innerHTML = '';
                list.sort((a,b) => b.created_at?.seconds - a.created_at?.seconds).slice(0, 50).forEach(t => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${new Date(t.created_at?.seconds * 1000).toLocaleDateString('ar-EG')}</td>
                            <td>${t.type.includes('income') ? '<span class="text-success">دخل</span>' : '<span class="text-danger">مصروف</span>'}</td>
                            <td>${t.description}</td>
                            <td class="fw-bold ${t.type.includes('income') ? 'text-success' : 'text-danger'}">${t.amount}</td>
                            <td>${t.currency}</td>
                        </tr>
                    `;
                });
            },

            renderEmployees: (list) => {
                const tbody = document.getElementById('employees-table');
                tbody.innerHTML = '';
                list.forEach(e => {
                    const net = e.net_salary !== undefined ? e.net_salary : e.salary;
                    tbody.innerHTML += `
                        <tr>
                            <td>${e.name}</td>
                            <td>${e.salary}</td>
                            <td class="fw-bold text-success">${net}</td>
                            <td>${e.currency}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-warning" onclick="uiManager.openEmpAction('${e.id}')">إدارة</button>
                            </td>
                        </tr>
                    `;
                });
            },

            // -- Generic Modals --
            openPayModal: async (id) => {
                const d = uiManager.allDebts.find(x => x.id === id);
                document.getElementById('pay-doc-id').value = id;
                document.getElementById('pay-remain').innerText = d.remaining_amount;
                document.getElementById('pay-curr').innerText = d.currency;
                document.getElementById('pay-amount').max = d.remaining_amount;
                new bootstrap.Modal(document.getElementById('paymentModal')).show();
            },

            openTransactionModal: (type) => {
                document.getElementById('financeForm').reset();
                document.getElementById('fin-type').value = type;
                document.getElementById('fin-modal-title').innerText = type === 'expense' ? 'تسجيل مصروف' : 'تسجيل دخل خارجي';
                const btn = document.getElementById('fin-submit-btn');
                btn.className = type === 'expense' ? 'btn btn-danger w-100' : 'btn btn-success w-100';
                new bootstrap.Modal(document.getElementById('financeModal')).show();
            },
            
            openEmpAction: (id) => {
                document.getElementById('act-emp-id').value = id;
                document.getElementById('empActionForm').reset();
                new bootstrap.Modal(document.getElementById('empActionModal')).show();
            },

            // Simplified for brevity (Espresso & Products same as before but dark styled)
            renderEspresso: (list) => {
                const t = document.getElementById('espresso-table'); t.innerHTML = '';
                list.filter(d => d.source === 'espresso' && d.status === 'active').forEach(d => {
                    t.innerHTML += `<tr><td>${d.customer_name}</td><td>${d.description}</td><td>${d.remaining_amount}</td><td>${d.currency}</td><td><button class="btn btn-sm btn-outline-success" onclick="uiManager.openPayModal('${d.id}')">دفع</button></td></tr>`;
                });
            },
            renderProducts: (list) => {
                const g = document.getElementById('espresso-grid'); g.innerHTML = '';
                list.filter(p => p.category === 'espresso').forEach(p => {
                    g.innerHTML += `<div class="col-6 col-md-3"><div class="card p-2 text-center"><img src="${p.image_url}" class="img-fluid rounded mb-2" style="height:100px;object-fit:cover;"><h6>${p.name}</h6><span class="text-info">${p.selling_price} ${p.currency}</span></div></div>`;
                });
            },
            openSimpleDebtModal: (src) => { document.getElementById('simpleDebtForm').reset(); document.getElementById('sim-source').value = src; new bootstrap.Modal(document.getElementById('simpleDebtModal')).show(); },
            openAddProductModal: (cat) => { document.getElementById('addProductForm').reset(); document.getElementById('prod-cat').value = cat; new bootstrap.Modal(document.getElementById('addProductModal')).show(); },
            openAddEmployeeModal: () => new bootstrap.Modal(document.getElementById('addEmpModal')).show(),
            
            updateStats: (list) => {
                let usd = 0, tryVal = 0, count = 0;
                list.forEach(d => {
                    if(d.status === 'active') {
                        count++;
                        if(d.currency === 'USD') usd += Number(d.remaining_amount);
                        else tryVal += Number(d.remaining_amount);
                    }
                });
                document.getElementById('dash-usd').innerText = usd + ' $';
                document.getElementById('dash-try').innerText = tryVal + ' ₺';
                document.getElementById('dash-count').innerText = count;
            }
        };

        // --- Print Logic (Browser Native) ---
        window.printManager = {
            printInvoice: (id) => {
                const d = uiManager.allDebts.find(x => x.id === id);
                let itemsHtml = '';
                if(d.items && d.items.length) {
                    itemsHtml = '<table style="width:100%;border-collapse:collapse;margin-top:20px;border:1px solid #000;"><thead><tr style="background:#eee;"><th>المادة</th><th>العدد</th><th>السعر</th><th>الإجمالي</th></tr></thead><tbody>';
                    d.items.forEach(i => {
                        itemsHtml += `<tr><td style="border:1px solid #000;padding:5px;">${i.item}</td><td style="border:1px solid #000;padding:5px;">${i.qty}</td><td style="border:1px solid #000;padding:5px;">${i.price}</td><td style="border:1px solid #000;padding:5px;">${i.qty*i.price}</td></tr>`;
                    });
                    itemsHtml += '</tbody></table>';
                } else {
                    itemsHtml = `<p style="margin-top:20px;font-size:18px;">${d.description}</p>`;
                }

                const html = `
                    <div style="direction:rtl;text-align:center;padding:20px;border:2px solid #000;">
                        <h1>مغسلة شباب المعرة</h1>
                        <p>تاريخ: ${new Date().toLocaleDateString('ar-EG')}</p>
                        <h2 style="margin:20px 0;">فاتورة للسيد: ${d.customer_name}</h2>
                        ${itemsHtml}
                        <div style="margin-top:30px;text-align:left;">
                            <h3>المبلغ المطلوب: ${d.remaining_amount} ${d.currency}</h3>
                            <p>المدفوع: ${d.paid_amount}</p>
                        </div>
                        <p style="margin-top:50px;font-size:12px;">شكراً لتعاملكم معنا</p>
                    </div>
                `;
                document.getElementById('print-area').innerHTML = html;
                window.print();
            }
        };

        // --- Events & Upload ---
        const upload = async (file) => {
            const fd = new FormData(); fd.append('file', file); fd.append('upload_preset', CLOUDINARY_PRESET);
            const res = await fetch(CLOUDINARY_URL, {method:'POST', body:fd});
            return (await res.json()).secure_url;
        };
        const toast = (m,t='s') => Toastify({text:m, style:{background:t=='s'?'#00c853':'#ff5252'}, duration:3000}).showToast();
        const showLoading = (s) => document.getElementById('loading-overlay').classList.toggle('d-none', !s);

        // Listeners
        document.getElementById('loginForm').addEventListener('submit', async(e)=>{
            e.preventDefault(); showLoading(true);
            try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); }
            catch(er) { document.getElementById('login-error').innerText="بيانات خاطئة"; showLoading(false); }
        });

        document.getElementById('invoiceForm').addEventListener('submit', (e)=>{
            e.preventDefault();
            const items = [];
            document.querySelectorAll('.invoice-item-row').forEach(r => {
                const sel = r.querySelector('.prod-select');
                items.push({
                    item: sel.value || 'خدمة مخصصة',
                    qty: r.querySelector('.prod-qty').value,
                    price: r.querySelector('.prod-price').value
                });
            });
            dataManager.addInvoice({
                customer_name: document.getElementById('inv-customer').value,
                currency: document.getElementById('inv-currency').value,
                total_amount: Number(document.getElementById('inv-total').innerText),
                items: items,
                description: 'فاتورة غسيل مفصلة'
            });
        });

        document.getElementById('paymentForm').addEventListener('submit', (e)=>{ e.preventDefault(); dataManager.processPayment(document.getElementById('pay-doc-id').value, document.getElementById('pay-amount').value); });
        
        document.getElementById('financeForm').addEventListener('submit', (e)=>{
            e.preventDefault();
            dataManager.addTransaction({
                type: document.getElementById('fin-type').value,
                description: document.getElementById('fin-desc').value,
                amount: Number(document.getElementById('fin-amount').value),
                currency: document.getElementById('fin-currency').value
            });
        });

        document.getElementById('empActionForm').addEventListener('submit', (e)=>{
            e.preventDefault();
            dataManager.addEmpAction(document.getElementById('act-emp-id').value, document.getElementById('act-type').value, document.getElementById('act-amount').value, document.getElementById('act-reason').value);
        });

        document.getElementById('addProductForm').addEventListener('submit', async(e)=>{
            e.preventDefault(); showLoading(true);
            const url = await upload(document.getElementById('prod-img').files[0]);
            await addDoc(collection(db,'artifacts',appId,'public','data','products'), {
                name: document.getElementById('prod-name').value,
                selling_price: document.getElementById('prod-price').value,
                currency: document.getElementById('prod-curr').value,
                image_url: url, category: document.getElementById('prod-cat').value
            });
            showLoading(false); toast('تم'); bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
        });
        
        document.getElementById('laundry-search').addEventListener('keyup', (e)=>{
            uiManager.renderLaundryCustomers(uiManager.allDebts, customersCache);
        });

        // Simple Debt (Espresso)
        document.getElementById('simpleDebtForm').addEventListener('submit', async(e)=>{
            e.preventDefault();
            await addDoc(collection(db,'artifacts',appId,'public','data','debts'),{
                customer_name: document.getElementById('sim-cust').value,
                description: document.getElementById('sim-desc').value,
                total_amount: Number(document.getElementById('sim-amount').value),
                currency: document.getElementById('sim-curr').value,
                source: document.getElementById('sim-source').value,
                remaining_amount: Number(document.getElementById('sim-amount').value),
                paid_amount: 0, status: 'active', created_at: serverTimestamp()
            });
            bootstrap.Modal.getInstance(document.getElementById('simpleDebtModal')).hide();
            toast("تم");
        });
        
        document.getElementById('addEmpForm').addEventListener('submit', async(e)=>{
            e.preventDefault();
            await addDoc(collection(db,'artifacts',appId,'public','data','employees'),{
                name: document.getElementById('emp-name').value,
                salary: document.getElementById('emp-salary').value,
                net_salary: Number(document.getElementById('emp-salary').value),
                currency: document.getElementById('emp-curr').value
            });
            bootstrap.Modal.getInstance(document.getElementById('addEmpModal')).hide(); toast('تم');
        });

        // Auth State
        onAuthStateChanged(auth, u => {
            showLoading(false);
            if(u) {
                document.getElementById('login-screen').classList.add('d-none');
                document.getElementById('main-app').classList.remove('d-none');
                dataManager.init();
            } else {
                document.getElementById('login-screen').classList.remove('d-none');
                document.getElementById('main-app').classList.add('d-none');
            }
        });

        // Globals
        window.router = { navigate: (id) => {
            document.querySelectorAll('.app-section').forEach(e=>e.classList.remove('active-section'));
            document.getElementById(id+'-section').classList.add('active-section');
            document.querySelectorAll('.nav-link').forEach(e=>e.classList.remove('active'));
        }};
        window.authManager = { logout: ()=>signOut(auth) };
        window.uiManager = uiManager;
        window.printManager = printManager;
    </script>
</body>
    </html>
